###############################
# Makefile for PNP
#
# Last Modified: 11-13-2023
###############################

VERSION=@PACKAGE_VERSION@

# Source code directories
srcdir=@srcdir@
SRC_BASE=@srcdir@/src
SRC_SHARE=@srcdir@/share
SRC_LIB=@srcdir@/lib
SRC_SCRIPTS=@srcdir@/scripts
SRC_CONFIG=@srcdir@/sample-config
SRC_MAN=@srcdir@/man
SRC_CONTRIB=@srcdir@/contrib
SRC_HELPERS=@srcdir@/helpers

CC=@CC@
CFLAGS=@CFLAGS@ @DEFS@
LDFLAGS=@LDFLAGS@ @LIBS@

prefix=@prefix@
exec_prefix=@exec_prefix@
LOGDIR=@localstatedir@
CFGDIR=@sysconfdir@
BINDIR=@bindir@
LIBEXECDIR=@libexecdir@
KOHANA=@KOHANA@
CGIDIR=@sbindir@
INSTALL=@INSTALL@
INSTALL_OPTS=@INSTALL_OPTS@
HTTP_INSTALL_OPTS=@HTTP_INSTALL_OPTS@
DATAROOTDIR=@datarootdir@
NAGIOS_VERSION=@NAGIOS_VER@
CACHE_DIR=@CACHE_DIR@

SELINUX=@SELINUX@
SELINUX_DEVELDIR=@SELINUX_DEVELDIR@

CP=@CP@
PERL=@PERL@

.PHONY: clean rpm dist distclean devclean

none:
	@echo "Please supply a command line argument (i.e. 'make all').  Other targets are:"
	@echo "   clean distclean dist"
	@echo "   install install-init install-config install-processperfdata install-html fullinstall"
	@echo "   install-plugins"

all:
	cd $(SRC_BASE) && $(MAKE)
	cd $(SRC_SHARE) && $(MAKE)
	cd $(SRC_SCRIPTS) && $(MAKE)
	cd $(SRC_CONFIG) && $(MAKE)
	chmod a+r $(SRC_CONTRIB)/ssi/status-header.ssi

	@echo ""
	@echo "*** Compile finished ***"
	@echo ""
	@echo "  make install"
	@echo "     - This installs directories, binaries and php files"
	@echo ""
	@echo "  make install_selinux"
	@echo "     - This installs the selinux setup (if you are using selinux)"
	@echo ""
	@echo "  make install_html"
	@echo "     - This installs the config for your http server"
	@echo ""
	@echo "  make use_sync"
	@echo "     - This installs the nagios config files for syncronous RRD processing"
	@echo ""
	@echo "  make use_bulk"
	@echo "     - This installs the nagios config files for bulk RRD processing"
	@echo ""
	@echo "  make use_npcd"
	@echo "     - This installs the nagios config and init scripts for npcd RRD processing"
	@echo ""
	@echo "  PLEASE NOTE: you should make only ONE of use_sync, use_bulk, or use_npcd"
	@echo ""
	@echo "  make restart_servers"
	@echo "     - This restarts servers: http, nagios, and maybe npcd"
	@echo ""
	@echo ""
	@echo "  make fullinstall"
	@echo "    -  install everything except the 'use_X' "
	@echo "    -  collection config. Suitable if you already "
	@echo "    -  have a pnp4nagios installation"
	@echo ""
	@echo "Enjoy."
	@echo ""

# this section from autoconf doc suggestions
# reautoconf if config changed
configure: configure.ac
	autoconf

# autoheader might not change config.h.in, so touch a stamp file.
include/config.h.in: include/stamp-h.in ;
include/stamp-h.in: configure.ac
	autoheader
	date -Is > 'include/stamp-h.in'

include/config.h: include/stamp-h ;
include/stamp-h: include/config.h.in config.status
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck


scripts:
	cd $(SRC_SCRIPTS) && $(MAKE)

share:
	cd $(SRC_SHARE) && $(MAKE)


clean:
	cd $(SRC_BASE) && $(MAKE) $@
	cd $(SRC_MAN) && $(MAKE) $@
	cd $(SRC_SHARE) && $(MAKE) $@
	cd $(SRC_LIB) && $(MAKE) $@
	cd $(SRC_SCRIPTS) && $(MAKE) $@
	cd $(SRC_CONFIG) && $(MAKE) $@
	-rm -f *.cfg core
	-rm -f *~ *.*~ */*~ */*.*~
	-rm -f config.log config.status config.cache
        ifeq ($(SELINUX),yes)
	rm -f pnp4nagios.fc pnp4nagios.if pnp4nagios.pp* tmp
        endif

distclean: 
	cd $(SRC_BASE) && $(MAKE) $@
	cd $(SRC_MAN) && $(MAKE) $@
	cd $(SRC_SHARE) && $(MAKE) $@
	cd $(SRC_LIB) && $(MAKE) $@
	cd $(SRC_SCRIPTS) && $(MAKE) $@
	cd $(SRC_CONFIG) && $(MAKE) $@
	-rm -f *.cfg core
	-rm -f *~ *.*~ */*~ */*.*~
	-rm -f config.log config.status config.cache
	rm -f Makefile include/stamp-h1 include/config.h config.status config.log
	rm -f subst summary
	rm -f $(SRC_CONTRIB)/ssi/status-header.ssi
	rm -f $(SRC_CONTRIB)/fedora/pnp4nagios.logrotate.conf
	rm -f $(SRC_CONTRIB)/fedora/logwatch/conf/logfiles/pnp4nagios.conf
        ifeq ($SELINUX,yes)
	rm -f pnp4nagios.fc pnp4nagios.if pnp4nagios.pp* tmp
        endif

devclean: distclean


install-init:
	cd $(SRC_SCRIPTS) && $(MAKE) $@


install-http:
	cd $(SRC_CONFIG) && $(MAKE) $@

	@echo " http server config file installed"
	@echo "Restart your webserver to activete your changes."
	@echo ""
	@echo ""
	@echo ""

install:
	cd $(SRC_BASE) && $(MAKE) $@
	cd $(SRC_MAN) && $(MAKE) $@
	cd $(SRC_SHARE) && $(MAKE) $@
	if [ x$(KOHANA) = xyes ]; then \
		cd $(SRC_LIB) && $(MAKE) $@; \
	fi
	cd $(SRC_SCRIPTS) && $(MAKE) $@
	cd $(SRC_CONFIG) && $(MAKE) $@
	$(INSTALL) $(HTTP_INSTALL_OPTS) -d $(CACHE_DIR)
	@echo ""
	@echo "*** Main program, Scripts and HTML files installed ***"
	@echo ""
	@echo "Please run one of 'make use_sync',"
	@echo "                  'make use_bulk', or"
	@echo "                  'make use_npcd'"
	@echo "to install config files for one of the methods"
	@echo "(sync, bulk, or npcd) of getting Nagios data to"
	@echo "the pnp4nagios rrd data collection."
	@echo ""
	@echo "Then please run 'make install-http' to install the"
	@echo "web configuration file"
	@echo ""
	@echo ""

install-selinux:
        ifeq ($(SELINUX),yes)
	$(MAKE) -f $(SELINUX_DEVELDIR)/Makefile load
	fixfiles restore @datadir@ @pkgsysconfdir@ 
	fixfiles restore @PERFDATA_DIR@ @logdir@
	fixfiles restore @PERFDATA_SPOOL_DIR@ @piddir@
        endif


install-unstripped:
	cd $(SRC_BASE) && $(MAKE) $@
	cd $(SRC_SHARE) && $(MAKE) $@
	cd $(SRC_SCRIPTS) && $(MAKE) $@
	$(MAKE) install-basic


NMAJ:=$(shell echo $(NAGIOS_VERSION)|cut -f1 -d.)
NMIN:=$(shell echo $(NAGIOS_VERSION)|cut -f2 -d.)
NREL:=$(shell echo $(NAGIOS_VERSION)|cut -f3 -d.)

use_sync:
	if (( $(NMAJ) == 4 && ( $(NMIN) < 4 || ( $(NMIN) == 4 && $(NREL) < 14 ) ) ))  ; then \
	echo "sync does not work with Nagios 4.0.0 .. 4.4.13). Stop" ; \
	exit 1 ; \
	fi
	cd $(SRC_CONFIG) && $(MAKE) $@

use_bulk:
	cd $(SRC_CONFIG) && $(MAKE) $@

use_npcd:
	cd $(SRC_CONFIG) && $(MAKE) $@
	cd $(SRC_SCRIPTS) && $(MAKE) install-daemoninit

use_X:
	cd $(SRC_CONFIG) && $(MAKE) $@

fullinstall:
	$(MAKE) install
	$(MAKE) install-selinux
	$(MAKE) install-http
	$(MAKE) restart_servers
	$(PERL) summary fullinstall
	@echo ""
	@echo "*** Main program, Scripts and HTML files installed ***"
	@echo "Config files in: @sysconfdir@ might need updating."
	@echo ""
	@echo "Right now, pnp4nagios will show a config page. To"
	@echo "show graphs, do:"
	@echo "  touch @datarootdir@/install.ignore"
	@echo ""
	@echo "Enjoy."
	@echo ""


dist:
	ci/maketar.sh $(VERSION)
	mv ci/pnp4nagios*.tgz .
	mv ci/pnp4nagios*.zip .

restart_servers:
	if [ "@init_type@" = "systemd" -o "@init_type@" = "sysv" ] ; then  \
	    service @NAGIOS_UNIT@ restart ; \
	    service @HTTP_UNIT@  restart ; \
	else  \
	   echo "don't know how to restart with @init_type@" ; \
	fi




